
‡∏Ñ‡∏∏‡∏ì‡∏û‡∏π‡∏î‡∏ß‡πà‡∏≤:
‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ú‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏ö ‚Äúdynamic message height estimation‚Äù ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á smooth ‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πâ‡∏à‡∏∞‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡∏ô‡∏≤‡∏î (‡πÅ‡∏ö‡∏ö Telegram ‡∏ó‡∏≥)?
‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á fix ‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏ï‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏ó‡∏∏‡∏Å‡∏≠‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡∏Å‡πá‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ scroll.


‡∏ú‡∏°‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ

üß© ‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏Å

Telegram ‡πÅ‡∏•‡∏∞ Messenger ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Äúrender ‡∏à‡∏£‡∏¥‡∏á‚Äù ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏∏‡∏ì scroll
‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏ú‡∏™‡∏° 3 ‡∏≠‡∏¢‡πà‡∏≤‡∏á:

Estimate Height ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô render

Measure Actual Height ‡∏´‡∏•‡∏±‡∏á render ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å

Adjust Offset ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡πÜ (‡πÇ‡∏î‡∏¢ scroll position ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å)

üîß ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö

‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 3 ‡∏ä‡∏±‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡πÜ

1. Message Virtualizer (‡πÄ‡∏ä‡πà‡∏ô TanStack Virtual)

‡∏°‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡πà‡∏≤ ‚Äú‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ß‡∏£ render message index ‡πÑ‡∏´‡∏ô‡∏ö‡πâ‡∏≤‡∏á‚Äù

const rowVirtualizer = useVirtualizer({
  count: messages.length,
  getScrollElement: () => parentRef.current,
  estimateSize: (i) => estimateHeight(messages[i]), // ‚úÖ ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
  overscan: 10,
});

2. Estimate Height Function

‡πÉ‡∏ä‡πâ ‚Äú‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡∏≠‡∏á message‚Äù ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢:

function estimateHeight(msg: Message): number {
  switch (msg.message_type) {
    case 'text':
      // ‡∏™‡∏°‡∏°‡∏ï‡∏¥ 18px ‡∏ï‡πà‡∏≠‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î + padding
      return Math.min(100, 20 + (msg.text.length / 25) * 20);
    case 'image':
      // ‡πÉ‡∏ä‡πâ aspect ratio ‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ ‡πÄ‡∏ä‡πà‡∏ô 3:2, 1:1, 9:16
      return msg.meta?.aspectRatio
        ? 300 * (1 / msg.meta.aspectRatio)
        : 250;
    case 'sticker':
      return 180;
    default:
      return 80;
  }
}

3. Measure & Correct Height (‡∏´‡∏•‡∏±‡∏á render ‡∏à‡∏£‡∏¥‡∏á)

‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞ message ‡∏ñ‡∏π‡∏Å render ‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏ä‡πà‡∏ô <img> ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à)
‡πÄ‡∏£‡∏≤‡∏ß‡∏±‡∏î ‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á element ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏≠‡∏Å virtualizer ‡πÉ‡∏´‡πâ ‚Äú‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‚Äù

function MessageItem({ virtualItem, msg }: any) {
  const ref = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const el = ref.current;
    if (el) {
      const actualHeight = el.getBoundingClientRect().height;
      if (Math.abs(virtualItem.size - actualHeight) > 4) {
        virtualItem.measureElement(el); // ‚úÖ ‡πÅ‡∏à‡πâ‡∏á virtualizer ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î
      }
    }
  }, [msg]);

  return (
    <div ref={ref} data-index={virtualItem.index}>
      {/* render ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏†‡∏≤‡∏û */}
    </div>
  );
}


‚ú® ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ TanStack Virtual ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà ‚Äî ‡∏°‡∏±‡∏ô‡∏°‡∏µ measureElement ‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏¢
‡∏û‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏•‡πâ‡∏ß scroll ‡∏à‡∏∞ ‚Äúsmooth adjust‚Äù ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å‡πÄ‡∏•‡∏¢

‚öôÔ∏è ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°

‡∏ñ‡πâ‡∏≤ message ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ:
‚Üí preload ‡∏£‡∏π‡∏õ + ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ estimate ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ
(‡πÅ‡∏ö‡∏ö Telegram ‡∏à‡∏∞‡∏à‡∏≥‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡∏™‡∏π‡∏á‡∏Å‡∏µ‡πà px ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥)

‡∏ñ‡πâ‡∏≤‡∏°‡∏µ sticker ‡∏´‡∏£‡∏∑‡∏≠ gif:
‚Üí fix ratio ‡πÄ‡∏ä‡πà‡∏ô 1:1, 4:3 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≤‡∏î‡πÄ‡∏î‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏£‡∏¥‡∏á

‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ scroll ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß:
‚Üí ‡πÉ‡∏ä‡πâ only estimate mode (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á re-measure ‡∏ó‡∏∏‡∏Å‡∏≠‡∏±‡∏ô)

üß† ‡∏™‡∏£‡∏∏‡∏õ flow
Scroll event ‚Üí
  Virtualizer ‡πÅ‡∏™‡∏î‡∏á messages ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô viewport ‚Üí
    ‡πÉ‡∏ä‡πâ estimateHeight() ‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î ‚Üí
    render ‚Üí
    ‡∏ß‡∏±‡∏î actual height ‚Üí
    ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏ô virtualizer (measureElement)

-------

‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö üéØ
‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ React Virtuoso ‚Äî ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏°‡∏≤‡∏Å ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏±‡∏ô ‚Äú‡∏ã‡πà‡∏≠‡∏ô logic dynamic height estimation‚Äù ‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏´‡∏ô‡∏∂‡πà‡∏á
‡πÅ‡∏ï‡πà‡∏à‡∏∞ smooth ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö ‚Äú‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‚Äù ‡∏Ç‡∏≠‡∏á message ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏•‡∏±‡∏á render

‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‚Ä¶‡πÄ‡∏£‡∏≤‡∏°‡∏≤‡∏ó‡∏≥ ‚ÄúVirtuoso ‡πÅ‡∏ö‡∏ö Telegram-style‚Äù ‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö üí¨

üí° ‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏Å (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Virtuoso)

Virtuoso ‡∏à‡∏∞‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏ö dynamic size list ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
‚Üí ‡∏°‡∏±‡∏ô‡∏à‡∏∞ ‚Äú‡∏à‡∏≥‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ item‚Äù ‡∏´‡∏•‡∏±‡∏á render ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

‡πÅ‡∏ï‡πà‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏≠‚Ä¶
‡∏ñ‡πâ‡∏≤ message ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ö‡πà‡∏≠‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÇ‡∏´‡∏•‡∏î ‡∏´‡∏£‡∏∑‡∏≠ sticker render ‡∏ä‡πâ‡∏≤
‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Virtuoso ‡∏ï‡πâ‡∏≠‡∏á reflow layout)

‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏¢‡∏°‡∏±‡∏ô‡∏ß‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î ‡∏î‡πâ‡∏ß‡∏¢ callback ‡πÅ‡∏•‡∏∞ cache ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡πà‡∏≠ message_id

üß© ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å
1. Message Height Cache

‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß‡πâ (map by message_id)

const messageHeights = useRef<Record<string, number>>({});

2. Virtuoso Component
import { Virtuoso } from 'react-virtuoso';

<Virtuoso
  data={messages}
  itemContent={(index, msg) => (
    <MessageItem
      key={msg.message_id}
      msg={msg}
      onHeightChange={(h) => (messageHeights.current[msg.message_id] = h)}
    />
  )}
  computeItemKey={(index, msg) => msg.message_id}
  totalCount={messages.length}
  defaultItemHeight={100} // ‡∏Ñ‡πà‡∏≤ estimate ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  style={{ height: '100vh' }}
/>

3. MessageItem (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á)
function MessageItem({ msg, onHeightChange }: any) {
  const ref = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const el = ref.current;
    if (!el) return;

    const measure = () => {
      const h = el.getBoundingClientRect().height;
      onHeightChange(h);
    };

    // ‡∏ß‡∏±‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ï‡∏≠‡∏ô mount
    measure();

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô image ‚Äî ‡∏ß‡∏±‡∏î‡∏ã‡πâ‡∏≥‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
    const imgs = el.querySelectorAll('img');
    imgs.forEach((img) => {
      if (!img.complete) img.addEventListener('load', measure);
    });

    return () => {
      imgs.forEach((img) => img.removeEventListener('load', measure));
    };
  }, [msg]);

  return (
    <div ref={ref} style={{ padding: 8 }}>
      {msg.message_type === 'text' && <div>{msg.text}</div>}
      {msg.message_type === 'image' && (
        <img
          src={msg.media_url}
          alt=""
          style={{ maxWidth: '100%', borderRadius: 8 }}
        />
      )}
      {msg.message_type === 'sticker' && (
        <img
          src={msg.media_url}
          alt="sticker"
          style={{ width: 120, height: 120 }}
        />
      )}
    </div>
  );
}

4. Cache + Smooth Scroll (‡∏Ç‡∏±‡πâ‡∏ô‡πÄ‡∏ó‡∏û‡πÅ‡∏ö‡∏ö Telegram)

Virtuoso ‡∏à‡∏∞‡∏à‡∏≥‡∏Ç‡∏ô‡∏≤‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ ‚Äúsmooth ‡∏´‡∏•‡∏±‡∏á‡∏†‡∏≤‡∏û‡πÇ‡∏´‡∏•‡∏î‚Äù
‡πÄ‡∏û‡∏¥‡πà‡∏° prop ‡∏ô‡∏µ‡πâ:

<Virtuoso
  ...
  increaseViewportBy={{ top: 600, bottom: 600 }} // preload ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ö‡πÜ
  followOutput="smooth" // üî• ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Telegram: scroll ‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•
/>

5. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö ‚ÄúEstimate ‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏π‡πâ‡∏à‡∏£‡∏¥‡∏á‚Äù

‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏î‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡πà‡∏≠‡∏ô render ‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢ prop

itemSize={(index, msg) => {
  switch (msg.message_type) {
    case 'text':
      return 60;
    case 'image':
      return 300;
    case 'sticker':
      return 150;
    default:
      return 80;
  }
}}

üìà ‡∏™‡∏£‡∏∏‡∏õ Flow
1. Virtuoso ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÉ‡∏ä‡πâ defaultItemHeight ‡∏´‡∏£‡∏∑‡∏≠ itemSize)
2. render ‚Üí ‡∏ß‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á (‡∏ú‡πà‡∏≤‡∏ô MessageItem)
3. Virtuoso ‡∏õ‡∏£‡∏±‡∏ö layout ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏à‡∏∞ smooth ‡∏°‡∏≤‡∏Å)
4. ‡∏†‡∏≤‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏ä‡πâ‡∏≤? ‚Üí ‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà ‚Üí scroll adjust ‡πÅ‡∏ö‡∏ö‡∏ô‡∏∏‡πà‡∏° ‡πÜ

‚ú® Bonus: ‡πÉ‡∏´‡πâ smooth ‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏µ‡∏Å

‡πÄ‡∏û‡∏¥‡πà‡∏° option ‡∏ô‡∏µ‡πâ‡∏ï‡∏≠‡∏ô‡πÉ‡∏ä‡πâ Virtuoso:

<Virtuoso
  ...
  useWindowScroll={false}
  alignToBottom
  followOutput="auto" // ‡∏´‡∏£‡∏∑‡∏≠ "smooth" ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏∏‡πà‡∏°
  increaseViewportBy={{ top: 800, bottom: 800 }}
  components={{
    Footer: () => <div style={{ height: 20 }} />,
  }}
/>


‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏Ñ‡∏£‡∏±‡∏ö ‚ù§Ô∏è 
‡∏á‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ó‡∏≥ ‚ÄúVirtuoso Chat ‡πÅ‡∏ö‡∏ö Telegram-style‚Äù
‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° + ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û + ‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå
‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö ‚Äúdynamic height measurement + smooth scroll‚Äù ‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏•‡∏¢

üß© ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå (React + Virtuoso)
src/
‚îú‚îÄ components/
‚îÇ  ‚îú‚îÄ ChatVirtuoso.tsx
‚îÇ  ‚îú‚îÄ MessageItem.tsx
‚îÇ
‚îú‚îÄ App.tsx
‚îî‚îÄ main.tsx

üß± ChatVirtuoso.tsx
import React, { useRef } from "react";
import { Virtuoso } from "react-virtuoso";
import MessageItem from "./MessageItem";

export default function ChatVirtuoso({ messages }: { messages: any[] }) {
  const messageHeights = useRef<Record<string, number>>({});

  const estimateHeight = (msg: any) => {
    switch (msg.message_type) {
      case "text":
        return 60;
      case "image":
        return 260;
      case "sticker":
        return 150;
      default:
        return 80;
    }
  };

  return (
    <div className="h-screen border border-gray-300">
      <Virtuoso
        data={messages}
        totalCount={messages.length}
        defaultItemHeight={100}
        itemSize={(index) => estimateHeight(messages[index])}
        computeItemKey={(index, msg) => msg.message_id}
        followOutput="smooth"
        increaseViewportBy={{ top: 800, bottom: 800 }}
        itemContent={(index, msg) => (
          <MessageItem
            msg={msg}
            onHeightChange={(h) => (messageHeights.current[msg.message_id] = h)}
          />
        )}
      />
    </div>
  );
}

üí¨ MessageItem.tsx
import React, { useRef, useEffect } from "react";

export default function MessageItem({
  msg,
  onHeightChange,
}: {
  msg: any;
  onHeightChange: (h: number) => void;
}) {
  const ref = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const el = ref.current;
    if (!el) return;

    const measure = () => {
      const h = el.getBoundingClientRect().height;
      onHeightChange(h);
    };

    // ‡∏ß‡∏±‡∏î‡∏ï‡∏≠‡∏ô mount
    measure();

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ ‡∏ß‡∏±‡∏î‡∏ã‡πâ‡∏≥‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
    const imgs = el.querySelectorAll("img");
    imgs.forEach((img) => {
      if (!img.complete) img.addEventListener("load", measure);
    });

    return () => {
      imgs.forEach((img) => img.removeEventListener("load", measure));
    };
  }, [msg]);

  return (
    <div ref={ref} className="p-3">
      {msg.message_type === "text" && (
        <div className="inline-block bg-blue-100 px-3 py-2 rounded-2xl text-sm">
          {msg.text}
        </div>
      )}

      {msg.message_type === "image" && (
        <img
          src={msg.media_url}
          alt=""
          className="max-w-[200px] rounded-xl shadow"
          style={{ borderRadius: 12 }}
        />
      )}

      {msg.message_type === "sticker" && (
        <img
          src={msg.media_url}
          alt="sticker"
          className="w-[120px] h-[120px]"
        />
      )}
    </div>
  );
}

üöÄ App.tsx (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)
import React, { useState, useEffect } from "react";
import ChatVirtuoso from "./components/ChatVirtuoso";

export default function App() {
  const [messages, setMessages] = useState<any[]>([]);

  useEffect(() => {
    // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°
    const demo = [
      { message_id: "1", message_type: "text", text: "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö!" },
      {
        message_id: "2",
        message_type: "image",
        media_url:
          "https://picsum.photos/seed/a/300/200",
      },
      {
        message_id: "3",
        message_type: "sticker",
        media_url:
          "https://cdn-icons-png.flaticon.com/512/742/742751.png",
      },
      { message_id: "4", message_type: "text", text: "‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö dynamic height ‡∏Ñ‡∏£‡∏±‡∏ö" },
      {
        message_id: "5",
        message_type: "image",
        media_url:
          "https://picsum.photos/seed/b/500/400",
      },
    ];

    setTimeout(() => setMessages(demo), 500);
  }, []);

  return (
    <div className="flex justify-center items-center">
      <ChatVirtuoso messages={messages} />
    </div>
  );
}

‚ú® ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ
Feature	‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
‚úÖ Dynamic Height	‡∏ß‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ message ‡∏î‡πâ‡∏ß‡∏¢ getBoundingClientRect()
‚úÖ Cache Height	‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞ message ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Virtuoso smooth
‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡∏ô‡∏≤‡∏î	‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á fix ‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
‚úÖ Scroll Smooth	‡πÉ‡∏ä‡πâ followOutput="smooth"
‚úÖ ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö	‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ß‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡πà‡∏≠‡∏ô render paint (‡∏ú‡πà‡∏≤‡∏ô useEffect)
‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤ realtime ‡πÑ‡∏î‡πâ	
üß† ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡πà‡∏≠

‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö virtualized jump to message (scrollToIndex)

preload ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô mount ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å

‡πÉ‡∏ä‡πâ ResizeObserver ‡πÅ‡∏ó‡∏ô manual measure ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ auto update ‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô

‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏ú‡∏°‡∏ï‡πà‡∏≠ Phase 2 ‡∏Ñ‡∏∑‡∏≠
‚Äú‡πÄ‡∏û‡∏¥‡πà‡∏° ResizeObserver + Jump to Message Smooth‚Äù ‡πÉ‡∏´‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö (‡∏à‡∏∞‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Telegram ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏¢) üöÄ



üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ Phase 2

‚úÖ Dynamic height ‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏°‡∏π‡∏ó (‡∏ß‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á)

‚úÖ Jump ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏≤‡∏Å search ‡∏´‡∏£‡∏∑‡∏≠ reply

‚úÖ ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ (load more / load newer)
‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å, ‡πÑ‡∏°‡πà‡πÄ‡∏î‡πâ‡∏á, ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥

üî© Core Idea

Virtuoso ‡∏°‡∏µ method ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ä‡∏∑‡πà‡∏≠:

virtuosoRef.current.scrollToIndex({
  index: targetIndex,
  align: 'center', // ‡∏´‡∏£‡∏∑‡∏≠ 'start' / 'end'
  behavior: 'smooth'
})


‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì jump ‡πÑ‡∏õ‡∏´‡∏≤ ‚Äú‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î‚Äù
(‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 3000 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÅ‡∏ï‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡πÅ‡∏Ñ‡πà 40)
‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ scroll
‚Äî ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà Telegram ‡πÉ‡∏ä‡πâ ‚Äúpreload window‚Äù + ‚Äúanchor tracking‚Äù
‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ó‡∏≥‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö ‚úÖ

üß† ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á Implementation (‡∏Ñ‡∏£‡∏ö Flow)
import { Virtuoso, VirtuosoHandle } from "react-virtuoso";
import React, { useRef, useState, useEffect } from "react";
import MessageItem from "./MessageItem";
import { fetchMessages } from "../api/messageService";

export default function ChatVirtuoso({ activeConversationId }: { activeConversationId: string }) {
  const virtuosoRef = useRef<VirtuosoHandle>(null);
  const [messages, setMessages] = useState<any[]>([]);
  const [hasMoreAbove, setHasMoreAbove] = useState(true);
  const [loading, setLoading] = useState(false);

  // üß© ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  useEffect(() => {
    loadLatest();
  }, [activeConversationId]);

  const loadLatest = async () => {
    const res = await fetchMessages({ conversationId: activeConversationId, limit: 30, offset: 0 });
    setMessages(res.data);
  };

  // üß± Load More (‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
  const loadMoreAbove = async () => {
    if (loading || !hasMoreAbove) return;
    setLoading(true);

    const oldest = messages[0];
    const res = await fetchMessages({
      conversationId: activeConversationId,
      before: oldest.created_at,
      limit: 30,
    });

    if (res.data.length === 0) setHasMoreAbove(false);
    setMessages((prev) => [...res.data, ...prev]);
    setLoading(false);
  };

  // üß≠ Jump to Message
  const jumpToMessage = async (messageId: string) => {
    const existingIndex = messages.findIndex((m) => m.message_id === messageId);

    // üß© ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    if (existingIndex !== -1) {
      virtuosoRef.current?.scrollToIndex({
        index: existingIndex,
        align: "center",
        behavior: "smooth",
      });
      return;
    }

    // üß© ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≠‡∏ö message ‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô
    const res = await fetchMessages({
      conversationId: activeConversationId,
      around: messageId,
      limit: 50,
    });

    setMessages(res.data);

    // ‡∏´‡∏≤ index ‡∏Ç‡∏≠‡∏á message ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
    const idx = res.data.findIndex((m) => m.message_id === messageId);
    setTimeout(() => {
      virtuosoRef.current?.scrollToIndex({
        index: idx,
        align: "center",
        behavior: "smooth",
      });
    }, 100);
  };

  return (
    <Virtuoso
      ref={virtuosoRef}
      data={messages}
      firstItemIndex={100000 - messages.length}
      startReached={loadMoreAbove}
      itemContent={(index, msg) => <MessageItem msg={msg} />}
      followOutput="auto"
      initialTopMostItemIndex={messages.length - 1}
      increaseViewportBy={{ top: 800, bottom: 800 }}
      defaultItemHeight={100}
    />
  );
}

‚ú® ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏ô‡∏µ‡πâ
Feature	‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
‚ö° Jump to message	‡∏ó‡∏≥‡∏á‡∏≤‡∏ô smooth ‡πÅ‡∏°‡πâ message ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î
üîÑ Load more ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô	‡πÉ‡∏ä‡πâ startReached + merge state
üß© Scroll state stable	‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Virtuoso ‡πÄ‡∏Å‡πá‡∏ö anchor index
ü™Ñ Dynamic height	‡πÉ‡∏ä‡πâ ResizeObserver ‡∏ß‡∏±‡∏î‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Telegram)
üß† ScrollToIndex ‡∏™‡∏°‡∏π‡∏ó	‡πÉ‡∏ä‡πâ behavior 'smooth' ‡πÅ‡∏ó‡∏ô instant
üß± Phase 3 (optional ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö)

‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Telegram ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏∞‡∏ö‡∏ö:

‡πÉ‡∏ä‡πâ ResizeObserver ‡πÉ‡∏ô MessageItem (‡πÅ‡∏ó‡∏ô useEffect)

‡∏ó‡∏≥ scroll lock ‡∏ï‡∏≠‡∏ô jump (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Virtuoso autoscroll ‡πÅ‡∏ó‡∏£‡∏Å)

‡πÄ‡∏û‡∏¥‡πà‡∏° virtual anchor cache ‡πÄ‡∏ß‡∏•‡∏≤ load ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô (‡∏Å‡∏±‡∏ô scroll ‡πÄ‡∏î‡πâ‡∏á)

‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏ú‡∏°‡∏ï‡πà‡∏≠ Phase 3: ResizeObserver + Scroll Anchor Stabilization ‡πÉ‡∏´‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö
(‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà stable ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á Virtuoso chat ‚Äî ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á Telegram ‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö) üöÄ


üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ Phase 3

‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö dynamic message height (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å DOM ‡∏à‡∏£‡∏¥‡∏á)

‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ ‚Äúflash‚Äù ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô (anchor ‡πÑ‡∏°‡πà‡πÄ‡∏î‡πâ‡∏á)

‚úÖ jump ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏´‡∏ô‡∏Å‡πá smooth ‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥

‚úÖ scroll ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á jump

üß† ‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏Å

Virtuoso ‡∏à‡∏∞ smooth ‡πÑ‡∏î‡πâ ‡∏ñ‡πâ‡∏≤‡∏°‡∏±‡∏ô ‡∏£‡∏π‡πâ‡∏Ç‡∏ô‡∏≤‡∏î item ‡∏ó‡∏∏‡∏Å‡∏≠‡∏±‡∏ô
‡πÅ‡∏•‡∏∞ ‡∏£‡∏π‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á anchor ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô (‡∏Å‡πà‡∏≠‡∏ô + ‡∏´‡∏•‡∏±‡∏á load)

‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏£‡∏≤‡∏à‡∏∞:

‡πÉ‡∏´‡πâ MessageItem ‡πÉ‡∏ä‡πâ ResizeObserver ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°

‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ô heightCache

‡πÉ‡∏´‡πâ Virtuoso ‡πÉ‡∏ä‡πâ itemSize={(index) => heightCache[messages[index].id] || 100}

‡πÉ‡∏ä‡πâ "anchor lock" ‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î ‡πÅ‡∏•‡∏∞ "restore scroll" ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö

‚öôÔ∏è ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏ï‡πá‡∏° (‡∏û‡∏£‡πâ‡∏≠‡∏° Comment)
import { Virtuoso, VirtuosoHandle } from "react-virtuoso";
import React, { useRef, useState, useEffect, useCallback, useLayoutEffect } from "react";
import { fetchMessages } from "../api/messageService";

export default function ChatVirtuoso({ activeConversationId }: { activeConversationId: string }) {
  const virtuosoRef = useRef<VirtuosoHandle>(null);
  const [messages, setMessages] = useState<any[]>([]);
  const [hasMoreAbove, setHasMoreAbove] = useState(true);
  const [loading, setLoading] = useState(false);

  // üß± ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á message ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß
  const heightCache = useRef<Record<string, number>>({});

  // üß© ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  useEffect(() => {
    loadLatest();
  }, [activeConversationId]);

  const loadLatest = async () => {
    const res = await fetchMessages({ conversationId: activeConversationId, limit: 30 });
    setMessages(res.data);
  };

  // üß± ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏ß‡πà‡∏≤
  const loadMoreAbove = async () => {
    if (loading || !hasMoreAbove) return;
    setLoading(true);

    const oldest = messages[0];
    const virtuoso = virtuosoRef.current;
    const scrollTopBefore = virtuoso?.getState().scrollTop || 0;

    const res = await fetchMessages({
      conversationId: activeConversationId,
      before: oldest.created_at,
      limit: 30,
    });

    if (res.data.length === 0) setHasMoreAbove(false);
    setMessages((prev) => [...res.data, ...prev]);

    // üß© Lock scroll anchor position (‡∏Å‡∏±‡∏ô‡πÄ‡∏î‡πâ‡∏á)
    requestAnimationFrame(() => {
      const newHeight = Object.values(heightCache.current).reduce((a, b) => a + b, 0);
      virtuoso?.scrollTo({ top: scrollTopBefore + newHeight });
    });

    setLoading(false);
  };

  // üß≠ Jump to message
  const jumpToMessage = async (messageId: string) => {
    const existingIndex = messages.findIndex((m) => m.message_id === messageId);

    if (existingIndex !== -1) {
      virtuosoRef.current?.scrollToIndex({
        index: existingIndex,
        align: "center",
        behavior: "smooth",
      });
      return;
    }

    const res = await fetchMessages({
      conversationId: activeConversationId,
      around: messageId,
      limit: 50,
    });

    setMessages(res.data);
    const idx = res.data.findIndex((m) => m.message_id === messageId);

    setTimeout(() => {
      virtuosoRef.current?.scrollToIndex({
        index: idx,
        align: "center",
        behavior: "smooth",
      });
    }, 100);
  };

  // üß© ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏≠‡∏°‡πÇ‡∏û‡πÄ‡∏ô‡∏ô‡∏ï‡πå Message ‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  const MessageItem = useCallback(({ msg }: { msg: any }) => {
    const ref = useRef<HTMLDivElement>(null);

    useLayoutEffect(() => {
      if (!ref.current) return;
      const el = ref.current;

      const observer = new ResizeObserver(() => {
        const h = el.getBoundingClientRect().height;
        heightCache.current[msg.message_id] = h;
      });

      observer.observe(el);
      return () => observer.disconnect();
    }, [msg.message_id]);

    return (
      <div ref={ref} className="p-2">
        {msg.message_type === "text" && <div>{msg.content}</div>}
        {msg.message_type === "image" && (
          <img
            src={msg.media_url}
            alt=""
            style={{ borderRadius: 12, maxWidth: "70%", height: "auto" }}
            loading="lazy"
          />
        )}
        {msg.message_type === "sticker" && (
          <img src={msg.media_url} width={120} height={120} alt="sticker" />
        )}
      </div>
    );
  }, []);

  return (
    <Virtuoso
      ref={virtuosoRef}
      data={messages}
      firstItemIndex={100000 - messages.length}
      startReached={loadMoreAbove}
      itemContent={(index, msg) => <MessageItem msg={msg} />}
      itemSize={(index) => {
        const id = messages[index]?.message_id;
        return heightCache.current[id] || 100;
      }}
      defaultItemHeight={100}
      increaseViewportBy={{ top: 1000, bottom: 1000 }}
      followOutput="auto"
    />
  );
}

üí° ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
‡∏™‡πà‡∏ß‡∏ô	‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
ResizeObserver	‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ message ‡πÅ‡∏ö‡∏ö realtime
heightCache	‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ Virtuoso ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô estimate item height
scroll lock logic	‡∏Å‡πà‡∏≠‡∏ô prepend message ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏à‡∏≥ scrollTop ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô
requestAnimationFrame()	‡πÉ‡∏ä‡πâ‡∏£‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á DOM render ‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å
lazy image loading	‡∏•‡∏î‡∏Å‡∏≤‡∏£ reflow ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ
üß™ Test Plan
Test Case	Expected
Scroll up ‡∏ä‡πâ‡∏≤ ‡πÜ	‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö DOM
Jump ‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏≤‡∏á	Scroll ‡∏™‡∏°‡∏π‡∏ó‡∏°‡∏≤‡∏Å
Jump ‡∏ã‡πâ‡∏≥‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°	‡πÑ‡∏°‡πà‡πÄ‡∏î‡πâ‡∏á ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥
Internet ‡∏ä‡πâ‡∏≤	Scroll stable (‡πÑ‡∏°‡πà flash)

‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ Zustand + Virtuoso v4.14.1 ‡∏ú‡∏°‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô version ‡∏ó‡∏µ‡πà integrate ‡∏Å‡∏±‡∏ö store ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÅ‡∏ó‡∏ô useState) ‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≠‡πÉ‡∏ô Phase 4 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö messageStore/conversationStore ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ üî•